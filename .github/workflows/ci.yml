name: CI Checks

on:
    push:
        branches: [ '**' ]
    pull_request:
        branches: [ master ]
    workflow_dispatch:

jobs:
    unittest:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup
              run: wget -qO- "https://cmake.org/files/v3.18/cmake-3.18.1-Linux-x86_64.tar.gz" | tar --strip-components=1 -xz -C /usr/local
            - name: Build
              run: |
                  cmake -S . -B build/ -DBUILD_TESTS=1 -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS='--coverage -DLIBRARY_LOG_LEVEL=LOG_DEBUG' -DDOWNLOAD_CERTS=0
                  make -C build/ all
            - name: Test
              run: make -C build/ test CTEST_OUTPUT_ON_FAILURE=TRUE
            - name: Coverage
              run: make -C build/ coverage
            - name: lcov-cop
              uses: ChicagoFlutter/lcov-cop@v1.0.2
              with:
                path: "./build/coverage.info"
                min_coverage: 99
                exclude: "**/*test*"
